<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>The Gilded Flagon - Pixel RPG</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    background: #0a0a14;
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 100vh;
    font-family: 'Press Start 2P', monospace;
    overflow: hidden;
  }
  #game {
    position: relative;
    image-rendering: pixelated;
    image-rendering: crisp-edges;
  }
  canvas {
    display: block;
    image-rendering: pixelated;
    image-rendering: crisp-edges;
  }
  #light-canvas {
    position: absolute;
    top: 0; left: 0;
    pointer-events: none;
    mix-blend-mode: multiply;
  }
  #fx-canvas {
    position: absolute;
    top: 0; left: 0;
    pointer-events: none;
  }
  #avatar-layer {
    position: absolute;
    top: 0; left: 0;
    width: 100%; height: 100%;
    pointer-events: none;
  }
  .avatar-wrap {
    position: absolute;
    display: flex;
    flex-direction: column;
    align-items: center;
  }
  .avatar-wrap img {
    image-rendering: pixelated;
    image-rendering: crisp-edges;
  }
  .nametag {
    font-family: 'Press Start 2P', monospace;
    font-size: 6px;
    color: #fff;
    text-shadow: 1px 1px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000;
    white-space: nowrap;
    margin-bottom: 2px;
    opacity: 0.9;
  }
  .nametag.player-tag { color: #5fe87a; }
  #hud {
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 36px;
    background: linear-gradient(180deg, rgba(10,10,20,0.95) 0%, rgba(10,10,20,0.7) 80%, transparent 100%);
    display: flex;
    align-items: center;
    padding: 0 12px;
    pointer-events: none;
    z-index: 1000;
  }
  .hud-item {
    display: flex;
    align-items: center;
    gap: 6px;
    margin-right: 20px;
  }
  .hud-icon { font-size: 12px; }
  .hud-text { font-size: 7px; color: #ccc; }
  .hud-val { font-size: 8px; color: #f0c050; }
  .hp-bar {
    width: 60px; height: 6px;
    background: #2a1a1a;
    border: 1px solid #4a2a2a;
  }
  .hp-fill {
    height: 100%;
    background: linear-gradient(90deg, #c03030, #e05050);
    width: 75%;
  }
  .mp-bar {
    width: 60px; height: 6px;
    background: #1a1a2a;
    border: 1px solid #2a2a4a;
  }
  .mp-fill {
    height: 100%;
    background: linear-gradient(90deg, #3030c0, #5050e0);
    width: 60%;
  }
  #tooltip {
    position: absolute;
    background: rgba(10,10,20,0.92);
    border: 2px solid #5a4a2a;
    color: #e0d0a0;
    font-size: 7px;
    padding: 6px 10px;
    pointer-events: none;
    display: none;
    z-index: 2000;
    max-width: 200px;
    line-height: 1.6;
    box-shadow: 0 0 12px rgba(0,0,0,0.8);
  }
  #controls {
    position: absolute;
    bottom: 8px;
    left: 50%;
    transform: translateX(-50%);
    font-size: 6px;
    color: rgba(200,200,220,0.4);
    pointer-events: none;
    z-index: 1000;
  }
</style>
</head>
<body>
<div id="game">
  <canvas id="floor"></canvas>
  <canvas id="light-canvas"></canvas>
  <canvas id="fx-canvas"></canvas>
  <div id="avatar-layer"></div>
  <div id="hud">
    <div class="hud-item">
      <span class="hud-icon">&#9876;</span>
      <span class="hud-text">Valen</span>
    </div>
    <div class="hud-item">
      <span class="hud-text">HP</span>
      <div class="hp-bar"><div class="hp-fill"></div></div>
    </div>
    <div class="hud-item">
      <span class="hud-text">MP</span>
      <div class="mp-bar"><div class="mp-fill"></div></div>
    </div>
    <div class="hud-item" style="margin-left:auto">
      <span class="hud-icon">&#9775;</span>
      <span class="hud-val">142</span>
      <span class="hud-text">gold</span>
    </div>
  </div>
  <div id="tooltip"></div>
  <div id="controls">ARROWS move &middot; SPACE interact</div>
</div>

<script>
// ── Config ──────────────────────────────────────────────
const T = 32;
const COLS = 30;
const ROWS = 22;
const W = COLS * T;
const H = ROWS * T;
const AV = 64;
const AV_OX = (AV - T) / 2;
const AV_OY = AV - T;
let tick = 0;

// ── Map legend ──────────────────────────────────────────
// 0=stone floor  1=wall  2=water  3=grass  4=path  5=rug
// 6=bar counter  7=barrel  8=door  9=bookshelf  A=fireplace
// B=chair  C=flowers  D=tree  E=fountain  F=torch_wall
const M = `
WWWWWWWWWWWWWWWWWWWWWWWWWWWWWW
WggggggDggWFF00000FFWF0000000W
WgCggCggggW00555500W000009090W
WggggggggDW00566500W009000090W
WgDgggCggg.005BB500.000090900W
WggggggggDW00500500W000000000W
WggCgDggggW00000000W007007F0W
WWWW.WWWWWW00070000WWWWW.WWWW
W00000000000000000000000000F0W
WF00000000044444000000000000W
W000000004444E44440000000000W
W000000004444E44440000000000W
W00000000044444000000000000FW
W0F000000004440000000000B00W
W000000000004000B000000BB00W
W00000000000400000000066600W
W0070000000040000000F06A600W
W000000000004000000000666F0W
W000B0000000400000000000000W
W00BB0F00000400000000070000W
W000000000004000000F0000000W
WWWWWWWWWWWW.WWWWWWWWWWWWWWWW
`.trim().split('\n').map(row => [...row]);

const LEGEND = {
  'W': 1, '0': 0, 'g': 3, 'D': 13, 'C': 12, '.': 8,
  '4': 4, '5': 5, '6': 6, '7': 7, '9': 9, 'A': 10,
  'B': 11, 'E': 14, 'F': 15, '2': 2,
};
const MAP = M.map(row => row.map(ch => LEGEND[ch] ?? 0));

const SOLID = new Set([1, 2, 6, 7, 9, 13, 14]);

// ── Torch positions (from 'F' tiles) ───────────────────
const TORCHES = [];
for (let r = 0; r < ROWS; r++)
  for (let c = 0; c < COLS; c++)
    if (MAP[r][c] === 15) TORCHES.push({ x: c * T + T/2, y: r * T + T/2 });

// Fireplace
const FIREPLACES = [];
for (let r = 0; r < ROWS; r++)
  for (let c = 0; c < COLS; c++)
    if (MAP[r][c] === 10) FIREPLACES.push({ x: c * T + T/2, y: r * T + T/2 });

// ── Canvas setup ────────────────────────────────────────
const floorCvs = document.getElementById('floor');
floorCvs.width = W; floorCvs.height = H;
const floorCtx = floorCvs.getContext('2d');

const lightCvs = document.getElementById('light-canvas');
lightCvs.width = W; lightCvs.height = H;
const lightCtx = lightCvs.getContext('2d');

const fxCvs = document.getElementById('fx-canvas');
fxCvs.width = W; fxCvs.height = H;
const fxCtx = fxCvs.getContext('2d');

// ── Color palettes ──────────────────────────────────────
const FLOOR_PAL = [
  ['#3e3852','#38334c'],  // 0 stone
  ['#252030','#201c2a'],  // 1 wall
  ['#2a4a7a','#264474'],  // 2 water
  ['#2b5a1a','#265214'],  // 3 grass
  ['#7a6a4a','#716244'],  // 4 path
  ['#6a2828','#622020'],  // 5 rug
  ['#5a3818','#523214'],  // 6 bar/counter
  ['#4a3828','#443222'],  // 7 barrel
  ['#5a4828','#544224'],  // 8 door
  ['#2a2240','#24203a'],  // 9 bookshelf
  ['#4a2010','#44180c'],  // 10 fireplace
  ['#4a3828','#443222'],  // 11 chair
  ['#2b5a1a','#265214'],  // 12 flowers (base=grass)
  ['#2b5a1a','#265214'],  // 13 tree (base=grass)
  ['#2a4a7a','#264474'],  // 14 fountain (base=water)
  ['#3e3852','#38334c'],  // 15 torch_wall (base=stone)
];

// ── Draw the floor ──────────────────────────────────────
function drawFloor() {
  for (let r = 0; r < ROWS; r++) {
    for (let c = 0; c < COLS; c++) {
      const t = MAP[r][c];
      const pal = FLOOR_PAL[t] || FLOOR_PAL[0];
      const x = c * T, y = r * T;
      floorCtx.fillStyle = (r + c) % 2 === 0 ? pal[0] : pal[1];
      floorCtx.fillRect(x, y, T, T);
      drawTileDetail(floorCtx, t, x, y, r, c);
    }
  }
}

function drawTileDetail(ctx, t, x, y, r, c) {
  const hash = (r * 31 + c * 17) & 0xFFFF;
  if (t === 1) {
    // Wall — stone bricks with mortar lines
    ctx.fillStyle = '#1a1628';
    ctx.fillRect(x, y + T - 1, T, 1);
    ctx.fillRect(x + T/2, y, 1, T);
    ctx.fillRect(x, y + T/2, T, 1);
    // Slight highlight on top row of bricks
    if (r > 0 && MAP[r-1][c] !== 1) {
      ctx.fillStyle = '#3a3452';
      ctx.fillRect(x+1, y+1, T-2, 3);
      ctx.fillStyle = '#1a1628';
      ctx.fillRect(x, y + T - 2, T, 2);
    }
  } else if (t === 3) {
    // Grass with varied tufts
    if (hash % 4 === 0) {
      ctx.fillStyle = '#3a7828';
      ctx.fillRect(x+6, y+4, 2, 5);
      ctx.fillRect(x+10, y+2, 2, 7);
      ctx.fillRect(x+14, y+5, 2, 4);
    }
    if (hash % 6 === 1) {
      ctx.fillStyle = '#4a8a38';
      ctx.fillRect(x+20, y+12, 2, 5);
      ctx.fillRect(x+24, y+10, 2, 6);
    }
    if (hash % 8 === 3) {
      ctx.fillStyle = '#1e4a10';
      ctx.fillRect(x+16, y+20, 3, 3);
    }
  } else if (t === 12) {
    // Flowers
    const colors = ['#e04040','#e0e040','#e080e0','#40a0e0'];
    for (let i = 0; i < 3; i++) {
      const fx = x + 4 + ((hash * (i+1)*7) % 20);
      const fy = y + 4 + ((hash * (i+1)*11) % 20);
      ctx.fillStyle = '#3a8028';
      ctx.fillRect(fx+1, fy+3, 2, 6);
      ctx.fillStyle = colors[(hash + i) % colors.length];
      ctx.fillRect(fx, fy, 4, 4);
      ctx.fillStyle = '#f0e060';
      ctx.fillRect(fx+1, fy+1, 2, 2);
    }
  } else if (t === 13) {
    // Tree
    ctx.fillStyle = '#3a2a10';
    ctx.fillRect(x+12, y+16, 8, 16);
    ctx.fillStyle = '#1e5a14';
    ctx.fillRect(x+2, y+2, 28, 18);
    ctx.fillStyle = '#28721c';
    ctx.fillRect(x+6, y+4, 20, 12);
    ctx.fillStyle = '#1a4e10';
    ctx.fillRect(x+4, y+8, 6, 8);
  } else if (t === 4) {
    // Worn path
    ctx.fillStyle = 'rgba(0,0,0,0.06)';
    if (hash % 3 === 0) ctx.fillRect(x+4, y+8, 10, 2);
    if (hash % 5 === 1) ctx.fillRect(x+14, y+18, 8, 2);
    // Pebbles
    if (hash % 7 === 2) {
      ctx.fillStyle = '#8a7a5a';
      ctx.fillRect(x+8, y+14, 3, 3);
      ctx.fillRect(x+20, y+6, 2, 2);
    }
  } else if (t === 5) {
    // Ornate rug
    ctx.fillStyle = '#7a2020';
    ctx.fillRect(x+2, y+2, T-4, T-4);
    ctx.fillStyle = '#a06020';
    ctx.fillRect(x+2, y+2, T-4, 2);
    ctx.fillRect(x+2, y+T-4, T-4, 2);
    ctx.fillRect(x+2, y+2, 2, T-4);
    ctx.fillRect(x+T-4, y+2, 2, T-4);
    if ((r+c) % 2 === 0) {
      ctx.fillStyle = '#8a3030';
      ctx.fillRect(x+8, y+8, T-16, T-16);
    }
  } else if (t === 6) {
    // Bar counter / table
    ctx.fillStyle = '#6a4820';
    ctx.fillRect(x+1, y+1, T-2, T-2);
    ctx.fillStyle = '#7a5828';
    ctx.fillRect(x+2, y+2, T-4, 4);
    ctx.fillStyle = '#4a3010';
    ctx.fillRect(x, y+T-3, T, 3);
    // Mugs on counter
    if (hash % 4 === 0) {
      ctx.fillStyle = '#8a8090';
      ctx.fillRect(x+8, y+8, 5, 7);
      ctx.fillStyle = '#c0a050';
      ctx.fillRect(x+8, y+8, 5, 2);
    }
  } else if (t === 7) {
    // Barrel with iron bands
    ctx.fillStyle = '#5a4830';
    ctx.fillRect(x+4, y+4, T-8, T-8);
    ctx.fillStyle = '#4a3820';
    ctx.fillRect(x+6, y+6, T-12, T-12);
    ctx.fillStyle = '#6a6a6a';
    ctx.fillRect(x+4, y+10, T-8, 2);
    ctx.fillRect(x+4, y+18, T-8, 2);
    ctx.fillStyle = '#3a2810';
    ctx.fillRect(x+14, y+12, 4, 5);
  } else if (t === 8) {
    // Door — wooden arch
    ctx.fillStyle = '#6a5030';
    ctx.fillRect(x+6, y, T-12, T);
    ctx.fillStyle = '#7a6038';
    ctx.fillRect(x+8, y+2, T-16, T-4);
    ctx.fillStyle = '#a08040';
    ctx.fillRect(x+T/2+2, y+T/2-1, 4, 4);
    // Arch stones
    ctx.fillStyle = '#3a3452';
    ctx.fillRect(x+4, y, 2, T);
    ctx.fillRect(x+T-6, y, 2, T);
  } else if (t === 9) {
    // Bookshelf
    ctx.fillStyle = '#3a2818';
    ctx.fillRect(x+1, y+1, T-2, T-2);
    const bookColors = ['#8a2020','#2020a0','#208a20','#8a6a20','#6020a0','#207a7a'];
    for (let i = 0; i < 3; i++) {
      const by = y + 3 + i * 10;
      ctx.fillStyle = '#2a1c10';
      ctx.fillRect(x+2, by+8, T-4, 2);
      for (let j = 0; j < 5; j++) {
        ctx.fillStyle = bookColors[(hash + i * 5 + j) % bookColors.length];
        ctx.fillRect(x + 4 + j * 5, by, 4, 8);
      }
    }
  } else if (t === 10) {
    // Fireplace
    ctx.fillStyle = '#3a3050';
    ctx.fillRect(x, y, T, T);
    ctx.fillStyle = '#2a2040';
    ctx.fillRect(x+4, y+8, T-8, T-8);
    ctx.fillStyle = '#1a1020';
    ctx.fillRect(x+6, y+10, T-12, T-12);
    // Stone frame
    ctx.fillStyle = '#4a4060';
    ctx.fillRect(x+2, y+4, 4, T-4);
    ctx.fillRect(x+T-6, y+4, 4, T-4);
    ctx.fillRect(x+2, y+4, T-4, 4);
  } else if (t === 11) {
    // Chair
    ctx.fillStyle = '#5a4020';
    ctx.fillRect(x+8, y+8, T-16, T-12);
    ctx.fillRect(x+8, y+4, T-16, 6);
    ctx.fillStyle = '#6a5028';
    ctx.fillRect(x+10, y+6, T-20, 4);
    // Legs
    ctx.fillStyle = '#3a2810';
    ctx.fillRect(x+8, y+T-6, 3, 6);
    ctx.fillRect(x+T-11, y+T-6, 3, 6);
  } else if (t === 14) {
    // Fountain
    ctx.fillStyle = '#4a4a60';
    ctx.fillRect(x+4, y+4, T-8, T-8);
    ctx.fillStyle = '#3a6aaa';
    ctx.fillRect(x+6, y+6, T-12, T-12);
    ctx.fillStyle = '#5a5a70';
    ctx.fillRect(x+12, y+10, 8, 12);
    ctx.fillStyle = '#6a6a80';
    ctx.fillRect(x+10, y+8, 12, 4);
  } else if (t === 15) {
    // Torch wall bracket
    ctx.fillStyle = '#4a4060';
    ctx.fillRect(x+12, y+8, 8, 4);
    ctx.fillStyle = '#5a5070';
    ctx.fillRect(x+14, y+4, 4, 8);
  }
}

drawFloor();

// ── Particles ───────────────────────────────────────────
class Particle {
  constructor(x, y, type) {
    this.x = x;
    this.y = y;
    this.type = type;
    this.life = 1;
    this.maxLife = 1;
    if (type === 'spark') {
      this.vx = (Math.random() - 0.5) * 2;
      this.vy = -Math.random() * 2 - 0.5;
      this.maxLife = 0.4 + Math.random() * 0.4;
      this.life = this.maxLife;
      this.size = 1 + Math.random() * 2;
    } else if (type === 'dust') {
      this.vx = (Math.random() - 0.5) * 0.3;
      this.vy = -Math.random() * 0.2 - 0.05;
      this.maxLife = 3 + Math.random() * 4;
      this.life = this.maxLife;
      this.size = 1 + Math.random();
    } else if (type === 'firefly') {
      this.vx = (Math.random() - 0.5) * 0.5;
      this.vy = (Math.random() - 0.5) * 0.5;
      this.maxLife = 4 + Math.random() * 6;
      this.life = this.maxLife;
      this.size = 2;
      this.phase = Math.random() * Math.PI * 2;
    } else if (type === 'water') {
      this.vx = (Math.random() - 0.5) * 0.3;
      this.vy = -Math.random() * 1.5 - 0.5;
      this.maxLife = 0.5 + Math.random() * 0.5;
      this.life = this.maxLife;
      this.size = 1.5;
    }
  }
  update(dt) {
    this.life -= dt;
    this.x += this.vx;
    this.y += this.vy;
    if (this.type === 'spark') {
      this.vy += 0.05;
    } else if (this.type === 'firefly') {
      this.vx += Math.sin(tick * 0.02 + this.phase) * 0.02;
      this.vy += Math.cos(tick * 0.015 + this.phase) * 0.02;
      this.vx *= 0.98;
      this.vy *= 0.98;
    }
    return this.life > 0;
  }
  draw(ctx) {
    const alpha = Math.max(0, this.life / this.maxLife);
    if (this.type === 'spark') {
      ctx.fillStyle = `rgba(255,${150 + Math.random()*80},50,${alpha})`;
      ctx.fillRect(this.x, this.y, this.size, this.size);
    } else if (this.type === 'dust') {
      ctx.fillStyle = `rgba(200,190,160,${alpha * 0.25})`;
      ctx.fillRect(this.x, this.y, this.size, this.size);
    } else if (this.type === 'firefly') {
      const pulse = 0.3 + Math.sin(tick * 0.08 + this.phase) * 0.7;
      const a = alpha * pulse;
      ctx.fillStyle = `rgba(180,255,80,${a * 0.8})`;
      ctx.fillRect(this.x-1, this.y-1, this.size+2, this.size+2);
      ctx.fillStyle = `rgba(220,255,150,${a})`;
      ctx.fillRect(this.x, this.y, this.size, this.size);
    } else if (this.type === 'water') {
      ctx.fillStyle = `rgba(140,200,255,${alpha * 0.6})`;
      ctx.fillRect(this.x, this.y, this.size, this.size);
    }
  }
}

const particles = [];
function spawnParticles() {
  // Torch sparks
  for (const t of TORCHES) {
    if (Math.random() < 0.15) {
      particles.push(new Particle(t.x + (Math.random()-0.5)*6, t.y - 4, 'spark'));
    }
  }
  // Fireplace sparks
  for (const fp of FIREPLACES) {
    if (Math.random() < 0.3) {
      particles.push(new Particle(fp.x + (Math.random()-0.5)*12, fp.y - 2, 'spark'));
    }
  }
  // Dust motes in indoor areas
  if (tick % 20 === 0) {
    const rx = Math.random() * W;
    const ry = Math.random() * H;
    const rc = Math.floor(rx / T);
    const rr = Math.floor(ry / T);
    if (rc >= 0 && rc < COLS && rr >= 0 && rr < ROWS) {
      const tile = MAP[rr][rc];
      if (tile === 0 || tile === 5 || tile === 15) {
        particles.push(new Particle(rx, ry, 'dust'));
      }
    }
  }
  // Fireflies in grass
  if (tick % 40 === 0) {
    for (let r = 0; r < ROWS; r++) {
      for (let c = 0; c < COLS; c++) {
        if (MAP[r][c] === 3 && Math.random() < 0.008) {
          particles.push(new Particle(c*T + Math.random()*T, r*T + Math.random()*T, 'firefly'));
        }
      }
    }
  }
  // Fountain water
  for (let r = 0; r < ROWS; r++) {
    for (let c = 0; c < COLS; c++) {
      if (MAP[r][c] === 14 && Math.random() < 0.12) {
        particles.push(new Particle(c*T + T/2 + (Math.random()-0.5)*4, r*T + T/2, 'water'));
      }
    }
  }
}

// ── Dynamic lighting ────────────────────────────────────
function drawLighting() {
  // Dark ambient
  lightCtx.fillStyle = '#12101a';
  lightCtx.fillRect(0, 0, W, H);

  lightCtx.globalCompositeOperation = 'lighter';

  // Torches
  for (const t of TORCHES) {
    const flicker = 0.85 + Math.sin(tick * 0.12 + t.x) * 0.08 + Math.random() * 0.07;
    const radius = 80 * flicker;
    const grad = lightCtx.createRadialGradient(t.x, t.y, 0, t.x, t.y, radius);
    grad.addColorStop(0, `rgba(255,180,80,${0.9 * flicker})`);
    grad.addColorStop(0.3, `rgba(220,120,40,${0.5 * flicker})`);
    grad.addColorStop(0.7, `rgba(150,60,20,${0.15 * flicker})`);
    grad.addColorStop(1, 'rgba(0,0,0,0)');
    lightCtx.fillStyle = grad;
    lightCtx.fillRect(t.x - radius, t.y - radius, radius * 2, radius * 2);
  }

  // Fireplace — bigger, warmer glow
  for (const fp of FIREPLACES) {
    const flicker = 0.8 + Math.sin(tick * 0.15 + fp.x * 0.1) * 0.1 + Math.random() * 0.1;
    const radius = 130 * flicker;
    const grad = lightCtx.createRadialGradient(fp.x, fp.y, 0, fp.x, fp.y, radius);
    grad.addColorStop(0, `rgba(255,150,50,${1.0 * flicker})`);
    grad.addColorStop(0.2, `rgba(240,100,30,${0.6 * flicker})`);
    grad.addColorStop(0.5, `rgba(180,50,10,${0.2 * flicker})`);
    grad.addColorStop(1, 'rgba(0,0,0,0)');
    lightCtx.fillStyle = grad;
    lightCtx.fillRect(fp.x - radius, fp.y - radius, radius * 2, radius * 2);
  }

  // Fountain — cool blue glow
  for (let r = 0; r < ROWS; r++) {
    for (let c = 0; c < COLS; c++) {
      if (MAP[r][c] === 14) {
        const fx = c * T + T/2, fy = r * T + T/2;
        const grad = lightCtx.createRadialGradient(fx, fy, 0, fx, fy, 50);
        grad.addColorStop(0, 'rgba(80,140,255,0.3)');
        grad.addColorStop(1, 'rgba(0,0,0,0)');
        lightCtx.fillStyle = grad;
        lightCtx.fillRect(fx - 50, fy - 50, 100, 100);
      }
    }
  }

  // Outdoor ambient light for grass
  for (let r = 0; r < ROWS; r++) {
    for (let c = 0; c < COLS; c++) {
      if (MAP[r][c] === 3 || MAP[r][c] === 12 || MAP[r][c] === 13) {
        const gx = c * T + T/2, gy = r * T + T/2;
        lightCtx.fillStyle = 'rgba(40,50,80,0.35)';
        lightCtx.fillRect(c * T, r * T, T, T);
      }
    }
  }

  lightCtx.globalCompositeOperation = 'source-over';
}

// ── SVG Avatar Factory (detailed characters) ────────────
function makeCharSVG(p, frame, accessory) {
  // p: palette with skin, hair, shirt, pants, boots, eyes, cloak, acc
  const leg = frame === 1 ? -4 : frame === 2 ? 4 : 0;
  const arm = frame === 1 ? 5 : frame === 2 ? -5 : 0;
  const bob = (frame === 1 || frame === 2) ? -2 : 0;

  let extra = '';

  // Accessories
  if (accessory === 'sword') {
    extra = `
      <rect x="${46+arm}" y="${28+bob}" width="3" height="22" fill="#a0a0b0"/>
      <rect x="${45+arm}" y="${26+bob}" width="5" height="4" fill="#c0a040"/>
      <rect x="${44+arm}" y="${30+bob}" width="7" height="2" fill="#c0a040"/>
    `;
  } else if (accessory === 'staff') {
    extra = `
      <rect x="${47+arm}" y="${10+bob}" width="3" height="38" fill="#6a5030"/>
      <rect x="${44+arm}" y="${6+bob}" width="9" height="8" fill="#7040c0" rx="0"/>
      <rect x="${46+arm}" y="${8+bob}" width="5" height="4" fill="#a060ff"/>
    `;
  } else if (accessory === 'shield') {
    extra = `
      <rect x="${10-arm}" y="${30+bob}" width="12" height="14" fill="#5a5a8a"/>
      <rect x="${12-arm}" y="${32+bob}" width="8" height="10" fill="#6a6a9a"/>
      <rect x="${14-arm}" y="${35+bob}" width="4" height="4" fill="#c0a040"/>
    `;
  } else if (accessory === 'bow') {
    extra = `
      <rect x="${48+arm}" y="${18+bob}" width="2" height="28" fill="#6a4a20"/>
      <rect x="${49+arm}" y="${18+bob}" width="1" height="28" fill="#c0b080" opacity="0.6"/>
      <rect x="${50+arm}" y="${16+bob}" width="3" height="4" fill="#6a4a20"/>
      <rect x="${50+arm}" y="${44+bob}" width="3" height="4" fill="#6a4a20"/>
    `;
  } else if (accessory === 'hat') {
    extra = `
      <rect x="14" y="${-2+bob}" width="36" height="6" fill="${p.acc || '#4a2080'}"/>
      <rect x="20" y="${-6+bob}" width="24" height="6" fill="${p.acc || '#4a2080'}"/>
      <rect x="30" y="${-4+bob}" width="3" height="3" fill="#e0c040"/>
    `;
  } else if (accessory === 'hood') {
    extra = `
      <rect x="16" y="${0+bob}" width="32" height="14" fill="${p.cloak || '#3a3a5a'}"/>
      <rect x="14" y="${8+bob}" width="6" height="18" fill="${p.cloak || '#3a3a5a'}"/>
      <rect x="44" y="${8+bob}" width="6" height="18" fill="${p.cloak || '#3a3a5a'}"/>
    `;
  }

  // Cloak
  let cloakSvg = '';
  if (p.cloak && accessory !== 'hood') {
    cloakSvg = `
      <rect x="18" y="${26+bob}" width="28" height="24" fill="${p.cloak}" opacity="0.85"/>
      <rect x="16" y="${28+bob}" width="4" height="20" fill="${p.cloak}" opacity="0.7"/>
      <rect x="44" y="${28+bob}" width="4" height="20" fill="${p.cloak}" opacity="0.7"/>
    `;
  }

  return `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64" shape-rendering="crispEdges">
    <!-- Shadow -->
    <ellipse cx="32" cy="60" rx="14" ry="3" fill="rgba(0,0,0,0.4)"/>

    <!-- Left boot -->
    <rect x="${21+leg}" y="${52+bob}" width="8" height="7" fill="${p.boots}"/>
    <rect x="${20+leg}" y="${57+bob}" width="10" height="2" fill="${p.boots}"/>
    <!-- Right boot -->
    <rect x="${35-leg}" y="${52+bob}" width="8" height="7" fill="${p.boots}"/>
    <rect x="${34-leg}" y="${57+bob}" width="10" height="2" fill="${p.boots}"/>

    <!-- Left leg -->
    <rect x="${22+leg}" y="${44+bob}" width="7" height="10" fill="${p.pants}"/>
    <!-- Right leg -->
    <rect x="${35-leg}" y="${44+bob}" width="7" height="10" fill="${p.pants}"/>

    <!-- Body -->
    <rect x="21" y="${26+bob}" width="22" height="20" fill="${p.shirt}"/>
    <!-- Shirt detail -->
    <rect x="30" y="${28+bob}" width="2" height="14" fill="rgba(0,0,0,0.1)"/>
    <!-- Belt -->
    <rect x="21" y="${43+bob}" width="22" height="3" fill="${p.boots}"/>
    <rect x="30" y="${43+bob}" width="4" height="3" fill="#c0a040"/>

    ${cloakSvg}

    <!-- Left arm -->
    <rect x="${14-arm}" y="${28+bob}" width="7" height="15" fill="${p.shirt}"/>
    <rect x="${14-arm}" y="${30+bob}" width="7" height="2" fill="rgba(0,0,0,0.1)"/>
    <rect x="${15-arm}" y="${42+bob}" width="5" height="5" fill="${p.skin}"/>
    <!-- Right arm -->
    <rect x="${43+arm}" y="${28+bob}" width="7" height="15" fill="${p.shirt}"/>
    <rect x="${43+arm}" y="${30+bob}" width="7" height="2" fill="rgba(0,0,0,0.1)"/>
    <rect x="${44+arm}" y="${42+bob}" width="5" height="5" fill="${p.skin}"/>

    ${extra}

    <!-- Neck -->
    <rect x="27" y="${22+bob}" width="10" height="6" fill="${p.skin}"/>

    <!-- Head -->
    <rect x="19" y="${6+bob}" width="26" height="20" fill="${p.skin}"/>

    <!-- Hair -->
    <rect x="17" y="${2+bob}" width="30" height="10" fill="${p.hair}"/>
    <rect x="17" y="${8+bob}" width="5" height="14" fill="${p.hair}"/>
    <rect x="42" y="${8+bob}" width="5" height="${p.hairLen || 10}" fill="${p.hair}"/>
    ${p.hairLong ? `<rect x="42" y="${8+bob}" width="5" height="20" fill="${p.hair}"/>
    <rect x="17" y="${8+bob}" width="5" height="20" fill="${p.hair}"/>` : ''}

    <!-- Eyes -->
    <rect x="24" y="${14+bob}" width="5" height="5" fill="#fff"/>
    <rect x="35" y="${14+bob}" width="5" height="5" fill="#fff"/>
    <rect x="26" y="${15+bob}" width="3" height="4" fill="${p.eyes}"/>
    <rect x="37" y="${15+bob}" width="3" height="4" fill="${p.eyes}"/>
    <rect x="26" y="${15+bob}" width="2" height="2" fill="white" opacity="0.8"/>
    <rect x="37" y="${15+bob}" width="2" height="2" fill="white" opacity="0.8"/>
    <!-- Eyebrows -->
    <rect x="23" y="${12+bob}" width="7" height="2" fill="${p.hair}"/>
    <rect x="34" y="${12+bob}" width="7" height="2" fill="${p.hair}"/>

    <!-- Mouth -->
    <rect x="29" y="${22+bob}" width="6" height="2" fill="${p.mouth || '#8a4040'}"/>

    <!-- Ears -->
    ${p.ears === 'elf' ? `
      <rect x="15" y="${8+bob}" width="4" height="4" fill="${p.skin}"/>
      <rect x="13" y="${6+bob}" width="4" height="4" fill="${p.skin}"/>
      <rect x="45" y="${8+bob}" width="4" height="4" fill="${p.skin}"/>
      <rect x="47" y="${6+bob}" width="4" height="4" fill="${p.skin}"/>
    ` : ''}
  </svg>`;
}

function avatarFrames(palette, accessory) {
  return [0,1,2,0].map(f =>
    'data:image/svg+xml,' + encodeURIComponent(makeCharSVG(palette, f, accessory))
  );
}

// ── Character definitions ───────────────────────────────
const CHARS = [
  { // Player — young adventurer
    name: 'Valen', palette: {
      skin:'#e8b878', hair:'#3a2208', shirt:'#28608a', pants:'#384868',
      boots:'#3a2810', eyes:'#1a3a6a', mouth:'#8a4545',
    }, accessory: 'sword', isPlayer: true,
  },
  { // Mage
    name: 'Elyndra', palette: {
      skin:'#f0d0a0', hair:'#e8e0f0', shirt:'#4a2880', pants:'#3a2860',
      boots:'#2a1840', eyes:'#6020a0', mouth:'#905050',
      cloak:'#5a30a0', hairLong:true, ears:'elf',
    }, accessory: 'staff',
  },
  { // Knight
    name: 'Gareth', palette: {
      skin:'#d0a070', hair:'#2a1a08', shirt:'#5a5a6a', pants:'#4a4a58',
      boots:'#2a2a30', eyes:'#2a2a1a', mouth:'#6a3838',
    }, accessory: 'shield',
  },
  { // Rogue
    name: 'Shade', palette: {
      skin:'#c8a068', hair:'#1a1a1a', shirt:'#2a2a2a', pants:'#222228',
      boots:'#1a1a18', eyes:'#3a6a3a', mouth:'#5a3535',
      cloak:'#1e1e28',
    }, accessory: 'hood',
  },
  { // Ranger
    name: 'Fern', palette: {
      skin:'#e0c090', hair:'#6a3818', shirt:'#3a6a2a', pants:'#4a3a20',
      boots:'#3a2a10', eyes:'#2a5a2a', mouth:'#7a4040',
      hairLong:true,
    }, accessory: 'bow',
  },
  { // Bard
    name: 'Pippin', palette: {
      skin:'#f0c898', hair:'#c06020', shirt:'#8a2040', pants:'#4a2838',
      boots:'#3a2018', eyes:'#3a2a1a', mouth:'#9a5050',
      acc:'#6a1838',
    }, accessory: 'hat',
  },
  { // Merchant
    name: 'Marta', palette: {
      skin:'#d8b080', hair:'#8a6a3a', shirt:'#8a7030', pants:'#5a4a2a',
      boots:'#3a2a18', eyes:'#3a3a2a', mouth:'#7a4040',
      hairLong:true,
    }, accessory: null,
  },
  { // Old wizard
    name: 'Aldric', palette: {
      skin:'#d0b890', hair:'#c8c0b0', shirt:'#2a2a5a', pants:'#2a2840',
      boots:'#2a2030', eyes:'#4a3a2a', mouth:'#6a4040',
      cloak:'#3030a0', hairLong:true,
    }, accessory: 'staff',
  },
  { // Guard
    name: 'Thane', palette: {
      skin:'#c09060', hair:'#1a1208', shirt:'#6a6a7a', pants:'#4a4a58',
      boots:'#2a2a28', eyes:'#1a1a1a', mouth:'#5a3535',
    }, accessory: 'sword',
  },
];

// ── NPC spawn positions ─────────────────────────────────
const SPAWNS = [
  { col: 11, row: 15, ci: 0 },  // Player
  { col: 11, row: 3,  ci: 1 },  // Mage — rug room
  { col: 22, row: 2,  ci: 2 },  // Knight — library
  { col: 3,  row: 3,  ci: 3 },  // Rogue — garden
  { col: 5,  row: 10, ci: 4 },  // Ranger — main hall
  { col: 13, row: 4,  ci: 5 },  // Bard — rug room
  { col: 24, row: 15, ci: 6 },  // Merchant — near bar
  { col: 24, row: 17, ci: 7 },  // Wizard — near fireplace
  { col: 14, row: 9,  ci: 8 },  // Guard — path
];

// ── Avatar class ────────────────────────────────────────
const avatarLayer = document.getElementById('avatar-layer');
const avatars = [];

class Avatar {
  constructor(col, row, charDef) {
    this.col = col; this.row = row;
    this.x = col * T; this.y = row * T;
    this.tx = this.x; this.ty = this.y;
    this.speed = charDef.isPlayer ? 2.8 : 0.8 + Math.random() * 0.6;
    this.isPlayer = !!charDef.isPlayer;
    this.name = charDef.name;
    this.frame = 0; this.ft = 0;
    this.moving = false;
    this.dir = 0;
    this.idleT = 0;
    this.idleD = 60 + Math.random() * 180;

    this.frames = avatarFrames(charDef.palette, charDef.accessory);

    // DOM
    this.wrap = document.createElement('div');
    this.wrap.className = 'avatar-wrap';

    this.tag = document.createElement('div');
    this.tag.className = 'nametag' + (this.isPlayer ? ' player-tag' : '');
    this.tag.textContent = this.name;
    this.wrap.appendChild(this.tag);

    this.img = document.createElement('img');
    this.img.src = this.frames[0];
    this.img.style.width = AV + 'px';
    this.img.style.height = AV + 'px';
    this.wrap.appendChild(this.img);

    avatarLayer.appendChild(this.wrap);
    this.syncPos();
  }

  syncPos() {
    this.wrap.style.left = (this.x - AV_OX) + 'px';
    this.wrap.style.top = (this.y - AV_OY - 12) + 'px';
    this.wrap.style.zIndex = Math.floor(this.y + T);
  }

  canMove(col, row) {
    if (col < 0 || col >= COLS || row < 0 || row >= ROWS) return false;
    if (SOLID.has(MAP[row][col])) return false;
    for (const a of avatars) {
      if (a === this) continue;
      if (Math.round(a.tx/T) === col && Math.round(a.ty/T) === row) return false;
    }
    return true;
  }

  moveTo(dc, dr) {
    if (this.moving) return;
    const nc = Math.round(this.x / T) + dc;
    const nr = Math.round(this.y / T) + dr;
    if (!this.canMove(nc, nr)) return;
    this.tx = nc * T; this.ty = nr * T;
    this.col = nc; this.row = nr;
    this.moving = true;
    if (dc < 0) this.dir = 2;
    else if (dc > 0) this.dir = 3;
    else if (dr < 0) this.dir = 1;
    else this.dir = 0;
  }

  update() {
    if (this.moving) {
      const dx = this.tx - this.x;
      const dy = this.ty - this.y;
      const d = Math.hypot(dx, dy);
      if (d < this.speed) {
        this.x = this.tx; this.y = this.ty;
        this.moving = false;
        this.frame = 0;
      } else {
        this.x += (dx/d) * this.speed;
        this.y += (dy/d) * this.speed;
        this.ft++;
        if (this.ft > 5) { this.ft = 0; this.frame = this.frame === 1 ? 2 : 1; }
      }
    } else if (!this.isPlayer) {
      this.idleT++;
      if (this.idleT >= this.idleD) {
        this.idleT = 0;
        this.idleD = 80 + Math.random() * 240;
        const dirs = [[0,1],[0,-1],[-1,0],[1,0]];
        const [dc,dr] = dirs[Math.floor(Math.random()*4)];
        this.moveTo(dc, dr);
      }
    }

    this.img.src = this.frames[this.frame];
    this.img.style.transform = this.dir === 2 ? 'scaleX(-1)' : '';
    this.syncPos();
  }
}

// Spawn all
for (const s of SPAWNS) {
  avatars.push(new Avatar(s.col, s.row, CHARS[s.ci]));
}
const player = avatars[0];

// ── Input ───────────────────────────────────────────────
const keys = {};
addEventListener('keydown', e => {
  keys[e.key] = true;
  if (e.key.startsWith('Arrow')) e.preventDefault();
});
addEventListener('keyup', e => keys[e.key] = false);

// ── Animated water on floor canvas ──────────────────────
function animateWater() {
  if (tick % 20 !== 0) return;
  for (let r = 0; r < ROWS; r++) {
    for (let c = 0; c < COLS; c++) {
      if (MAP[r][c] !== 14) continue;
      const x = c*T, y = r*T;
      // Redraw base
      floorCtx.fillStyle = (r+c)%2===0 ? '#3a6aaa' : '#3564a0';
      floorCtx.fillRect(x+6, y+6, T-12, T-12);
      // Shimmer
      floorCtx.fillStyle = `rgba(160,210,255,${0.15 + Math.sin(tick*0.04+c+r)*0.1})`;
      const wy = y+8 + Math.sin(tick*0.03 + c*2)*4;
      floorCtx.fillRect(x+8, wy, T-16, 2);
    }
  }
}

// ── Animated fireplace ──────────────────────────────────
function animateFire() {
  for (const fp of FIREPLACES) {
    const fc = Math.floor(fp.x / T);
    const fr = Math.floor(fp.y / T);
    const x = fc * T, y = fr * T;
    // Redraw dark interior
    floorCtx.fillStyle = '#1a1020';
    floorCtx.fillRect(x+6, y+10, T-12, T-12);
    // Fire
    const colors = ['#ff6020','#ff8030','#ffaa40','#ffe060'];
    for (let i = 0; i < 5; i++) {
      const fx = x + 10 + Math.sin(tick*0.15 + i*2)*4 + (i%3)*3;
      const fy = y + T - 8 - Math.abs(Math.sin(tick*0.1 + i*1.5))*8 - i*2;
      const fs = 3 + Math.sin(tick*0.2 + i)*2;
      floorCtx.fillStyle = colors[i % colors.length];
      floorCtx.fillRect(fx, fy, fs, fs + 2);
    }
  }
}

// ── Game loop ───────────────────────────────────────────
function loop() {
  tick++;

  // Input
  if (!player.moving) {
    if (keys.ArrowLeft)  player.moveTo(-1, 0);
    else if (keys.ArrowRight) player.moveTo(1, 0);
    else if (keys.ArrowUp)    player.moveTo(0, -1);
    else if (keys.ArrowDown)  player.moveTo(0, 1);
  }

  // Update avatars
  for (const a of avatars) a.update();

  // Animated tiles
  animateWater();
  animateFire();

  // Particles
  spawnParticles();
  fxCtx.clearRect(0, 0, W, H);
  for (let i = particles.length - 1; i >= 0; i--) {
    if (!particles[i].update(1/60)) {
      particles.splice(i, 1);
    } else {
      particles[i].draw(fxCtx);
    }
  }

  // Lighting
  drawLighting();

  requestAnimationFrame(loop);
}

requestAnimationFrame(loop);
</script>
</body>
</html>
